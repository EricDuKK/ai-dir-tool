---
description: ç›¸å…³æ•°æ®åº“æ“ä½œæ—¶éœ€è¦æŸ¥çœ‹è¯¥rules
alwaysApply: false
---

# AIå·¥å…·é›†æ•°æ®åº“è®¾è®¡æ–‡æ¡£ (ä½¿ç”¨ RLS)

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£ä¸ºAIå·¥å…·é›†ç½‘ç«™è®¾è®¡æ•°æ®åº“è¡¨ç»“æ„ï¼Œä½¿ç”¨ Supabase RLS è¿›è¡Œå®‰å…¨æ§åˆ¶ï¼ŒåŒ…å«åˆ†ç±»ç®¡ç†ã€AIå·¥å…·ç®¡ç†å’Œç”¨æˆ·æäº¤å®¡æ ¸æµç¨‹ã€‚

## ğŸ—„ï¸ æ•°æ®åº“è¡¨è®¾è®¡

### 1. åˆ†ç±»è¡¨ (categories)

**ç”¨é€”**: å­˜å‚¨é¦–é¡µå·¦ä¾§åˆ†ç±»æ•°æ®ï¼Œå‚è€ƒ sidebar.tsx ç»„ä»¶éœ€æ±‚

```sql
-- åˆ›å»ºåˆ†ç±»è¡¨
CREATE TABLE categories (
  id VARCHAR(50) PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  name_zh VARCHAR(100) NOT NULL,
  icon VARCHAR(10) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ’å…¥åˆå§‹æ•°æ®
INSERT INTO categories (id, name, name_zh, icon) VALUES
('writing', 'AI Writing Tools', 'AIå†™ä½œå·¥å…·', 'âœï¸'),
('image', 'AI Image Tools', 'AIå›¾åƒå·¥å…·', 'ğŸ–¼ï¸'),
('video', 'AI Video Tools', 'AIè§†é¢‘å·¥å…·', 'ğŸ¬'),
('office', 'AI Office Tools', 'AIåŠå…¬å·¥å…·', 'ğŸ“'),
('agent', 'AI Agents', 'AIæ™ºèƒ½ä½“', 'ğŸ¤–'),
('chat', 'AI Chat Assistants', 'AIèŠå¤©åŠ©æ‰‹', 'ğŸ’¬'),
('coding', 'AI Coding Tools', 'AIç¼–ç¨‹å·¥å…·', 'ğŸ’»'),
('design', 'AI Design Tools', 'AIè®¾è®¡å·¥å…·', 'ğŸ¨'),
('audio', 'AI Audio Tools', 'AIéŸ³é¢‘å·¥å…·', 'ğŸµ'),
('search', 'AI Search Engines', 'AIæœç´¢å¼•æ“', 'ğŸ”');

-- å¯ç”¨ RLS
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥ï¼šæ‰€æœ‰äººéƒ½å¯ä»¥æŸ¥çœ‹åˆ†ç±»
CREATE POLICY "Categories are viewable by everyone" ON categories
  FOR SELECT USING (true);

-- åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹åˆ†ç±»
CREATE POLICY "Only admins can modify categories" ON categories
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM auth.users 
      WHERE auth.users.id = auth.uid() 
      AND auth.users.raw_user_meta_data->>'role' = 'admin'
    )
  );
```

### 2. AIå·¥å…·è¡¨ (ai_tools)

**ç”¨é€”**: å­˜å‚¨æ‰€æœ‰AIå·¥å…·çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬å·²å®¡æ ¸é€šè¿‡çš„å·¥å…·

```sql
-- åˆ›å»ºAIå·¥å…·è¡¨
CREATE TABLE ai_tools (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(200) NOT NULL,
  name_zh VARCHAR(200) NOT NULL,
  slug VARCHAR(200) NOT NULL UNIQUE,
  description TEXT NOT NULL,
  description_zh TEXT NOT NULL,
  detailed_introduction TEXT,
  logo_url VARCHAR(500),
  image_url TEXT NOT NULL
  category_id VARCHAR(50) NOT NULL REFERENCES categories(id),
  website_url VARCHAR(500) NOT NULL,
  is_hot BOOLEAN DEFAULT false,
  is_new BOOLEAN DEFAULT false,
  tags TEXT[],
  view_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'archived')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id),
  approved_at TIMESTAMP WITH TIME ZONE,
  approved_by UUID REFERENCES auth.users(id)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_ai_tools_category ON ai_tools(category_id);
CREATE INDEX idx_ai_tools_status ON ai_tools(status);
CREATE INDEX idx_ai_tools_is_hot ON ai_tools(is_hot);
CREATE INDEX idx_ai_tools_is_new ON ai_tools(is_new);
CREATE INDEX idx_ai_tools_created_at ON ai_tools(created_at);
CREATE INDEX idx_ai_tools_view_count ON ai_tools(view_count);
CREATE INDEX idx_ai_tools_like_count ON ai_tools(like_count);
CREATE INDEX idx_ai_tools_slug ON ai_tools(slug);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_ai_tools_search ON ai_tools USING gin(to_tsvector('english', name || ' ' || name_zh || ' ' || description || ' ' || description_zh));

-- å¯ç”¨ RLS
ALTER TABLE ai_tools ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥ï¼šæ‰€æœ‰äººéƒ½å¯ä»¥æŸ¥çœ‹æ´»è·ƒçš„å·¥å…·
CREATE POLICY "Active tools are viewable by everyone" ON ai_tools
  FOR SELECT USING (status = 'active');

-- åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å·¥å…·
CREATE POLICY "Admins can view all tools" ON ai_tools
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM auth.users 
      WHERE auth.users.id = auth.uid() 
      AND auth.users.raw_user_meta_data->>'role' = 'admin'
    )
  );

-- åªæœ‰ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹å·¥å…·
CREATE POLICY "Only admins can modify tools" ON ai_tools
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM auth.users 
      WHERE auth.users.id = auth.uid() 
      AND auth.users.raw_user_meta_data->>'role' = 'admin'
    )
  );
```

### 3. ç”¨æˆ·æäº¤è¡¨ (user_submissions)

**ç”¨é€”**: å­˜å‚¨ç”¨æˆ·æäº¤çš„AIå·¥å…·è®°å½•ï¼Œç®¡ç†å®¡æ ¸æµç¨‹

```sql
-- åˆ›å»ºç”¨æˆ·æäº¤è¡¨
CREATE TABLE user_submissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  tool_name VARCHAR(200) NOT NULL,
  tool_name_zh VARCHAR(200),
  tool_url VARCHAR(500) NOT NULL,
  tool_description TEXT NOT NULL,
  tool_description_zh TEXT,
  tool_logo_url VARCHAR(500),
  category_id VARCHAR(50) NOT NULL REFERENCES categories(id),
  tags TEXT[],
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'needs_revision')),
  submitted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  reviewed_at TIMESTAMP WITH TIME ZONE,
  reviewed_by UUID REFERENCES auth.users(id),
  review_notes TEXT,
  rejection_reason TEXT,
  revision_notes TEXT,
  ai_tool_id UUID REFERENCES ai_tools(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_submissions_user_id ON user_submissions(user_id);
CREATE INDEX idx_user_submissions_status ON user_submissions(status);
CREATE INDEX idx_user_submissions_submitted_at ON user_submissions(submitted_at);
CREATE INDEX idx_user_submissions_category ON user_submissions(category_id);
CREATE INDEX idx_user_submissions_reviewed_by ON user_submissions(reviewed_by);
CREATE INDEX idx_user_submissions_ai_tool_id ON user_submissions(ai_tool_id);

-- å¯ç”¨ RLS
ALTER TABLE user_submissions ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥ï¼šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æäº¤
CREATE POLICY "Users can view own submissions" ON user_submissions
  FOR SELECT USING (auth.uid() = user_id);

-- ç”¨æˆ·åªèƒ½æ’å…¥è‡ªå·±çš„æäº¤
CREATE POLICY "Users can insert own submissions" ON user_submissions
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„å¾…å®¡æ ¸æäº¤
CREATE POLICY "Users can update own pending submissions" ON user_submissions
  FOR UPDATE USING (auth.uid() = user_id AND status = 'pending');

-- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æäº¤
CREATE POLICY "Admins can view all submissions" ON user_submissions
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM auth.users 
      WHERE auth.users.id = auth.uid() 
      AND auth.users.raw_user_meta_data->>'role' = 'admin'
    )
  );

-- ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹æ‰€æœ‰æäº¤
CREATE POLICY "Admins can modify all submissions" ON user_submissions
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM auth.users 
      WHERE auth.users.id = auth.uid() 
      AND auth.users.raw_user_meta_data->>'role' = 'admin'
    )
  );
```

## ğŸ”— è¡¨å…³ç³»è¯´æ˜

### å…³ç³»å›¾
```
categories (1) â†â†’ (N) ai_tools
categories (1) â†â†’ (N) user_submissions
auth.users (1) â†â†’ (N) ai_tools (created_by)
auth.users (1) â†â†’ (N) user_submissions
user_submissions (1) â†â†’ (1) ai_tools (ai_tool_id) [å®¡æ ¸é€šè¿‡å]
```

### ä¸šåŠ¡æµç¨‹
1. **ç”¨æˆ·æäº¤** â†’ `user_submissions` è¡¨ (status: pending)
2. **ç®¡ç†å‘˜å®¡æ ¸** â†’ æ›´æ–° `user_submissions` è¡¨ (status: approved/rejected)
3. **å®¡æ ¸é€šè¿‡** â†’ åˆ›å»º `ai_tools` è®°å½•ï¼Œå…³è” `user_submissions.ai_tool_id`

## ğŸ“Š æ•°æ®ç»Ÿè®¡æŸ¥è¯¢

### å¸¸ç”¨æŸ¥è¯¢SQL

```sql
-- 1. è·å–åˆ†ç±»åŠå…¶å·¥å…·æ•°é‡
SELECT 
  c.id,
  c.name_zh,
  c.icon,
  COUNT(t.id) as tool_count
FROM categories c
LEFT JOIN ai_tools t ON c.id = t.category_id AND t.status = 'active'
GROUP BY c.id, c.name_zh, c.icon
ORDER BY c.id;

-- 2. è·å–çƒ­é—¨å·¥å…·
SELECT 
  t.*,
  c.name_zh as category_name
FROM ai_tools t
JOIN categories c ON t.category_id = c.id
WHERE t.status = 'active' AND t.is_hot = true
ORDER BY t.view_count DESC, t.created_at DESC
LIMIT 10;

-- 3. è·å–æœ€æ–°å·¥å…·
SELECT 
  t.*,
  c.name_zh as category_name
FROM ai_tools t
JOIN categories c ON t.category_id = c.id
WHERE t.status = 'active' AND t.is_new = true
ORDER BY t.created_at DESC
LIMIT 10;

-- 4. æœç´¢å·¥å…·
SELECT 
  t.*,
  c.name_zh as category_name
FROM ai_tools t
JOIN categories c ON t.category_id = c.id
WHERE t.status = 'active' 
  AND (
    t.name ILIKE '%æœç´¢è¯%' OR 
    t.name_zh ILIKE '%æœç´¢è¯%' OR
    t.description ILIKE '%æœç´¢è¯%' OR
    t.description_zh ILIKE '%æœç´¢è¯%'
  )
ORDER BY t.view_count DESC;

-- 5. ç”¨æˆ·æäº¤ç»Ÿè®¡
SELECT 
  u.email,
  COUNT(s.id) as total_submissions,
  COUNT(CASE WHEN s.status = 'approved' THEN 1 END) as approved_count,
  COUNT(CASE WHEN s.status = 'pending' THEN 1 END) as pending_count,
  COUNT(CASE WHEN s.status = 'rejected' THEN 1 END) as rejected_count
FROM auth.users u
LEFT JOIN user_submissions s ON u.id = s.user_id
GROUP BY u.id, u.email;

-- 6. å®¡æ ¸å·¥ä½œå°æŸ¥è¯¢
SELECT 
  s.*,
  u.email as submitter_email,
  c.name_zh as category_name,
  reviewer.email as reviewer_email
FROM user_submissions s
JOIN auth.users u ON s.user_id = u.id
JOIN categories c ON s.category_id = c.id
LEFT JOIN auth.users reviewer ON s.reviewed_by = reviewer.id
WHERE s.status = 'pending'
ORDER BY s.submitted_at ASC;
```

## ğŸ” RLS å®‰å…¨ç­–ç•¥

### 1. ç”¨æˆ·è§’è‰²ç®¡ç†
```sql
-- åˆ›å»ºç”¨æˆ·è§’è‰²å‡½æ•°
CREATE OR REPLACE FUNCTION get_user_role(user_id UUID)
RETURNS TEXT AS $$
BEGIN
  RETURN (
    SELECT raw_user_meta_data->>'role' 
    FROM auth.users 
    WHERE id = user_id
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
CREATE OR REPLACE FUNCTION is_admin(user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN get_user_role(user_id) = 'admin';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 2. æƒé™æ§åˆ¶ç¤ºä¾‹
```sql
-- æ›´æ–°ç­–ç•¥ä½¿ç”¨å‡½æ•°
DROP POLICY "Only admins can modify categories" ON categories;
CREATE POLICY "Only admins can modify categories" ON categories
  FOR ALL USING (is_admin(auth.uid()));

DROP POLICY "Admins can view all tools" ON ai_tools;
CREATE POLICY "Admins can view all tools" ON ai_tools
  FOR SELECT USING (is_admin(auth.uid()));

DROP POLICY "Admins can view all submissions" ON user_submissions;
CREATE POLICY "Admins can view all submissions" ON user_submissions
  FOR SELECT USING (is_admin(auth.uid()));
```

## ğŸš€ å®¢æˆ·ç«¯å®ç°

### 1. ç¯å¢ƒå˜é‡é…ç½®
```env
# Supabaseé…ç½®
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 2. æ•°æ®è®¿é—®ç¤ºä¾‹
```typescript
// lib/supabase/client.ts
import { createClient } from '@supabase/supabase-js'

export function createClient() {
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}

// è·å–æ‰€æœ‰åˆ†ç±»
export async function getCategories() {
  const supabase = createClient()
  const { data, error } = await supabase
    .from('categories')
    .select('*')
    .order('id')
  
  if (error) throw error
  return data
}

// è·å–æ´»è·ƒçš„AIå·¥å…·
export async function getActiveTools() {
  const supabase = createClient()
  const { data, error } = await supabase
    .from('ai_tools')
    .select(`
      *,
      categories(name_zh, icon)
    `)
    .eq('status', 'active')
    .order('created_at', { ascending: false })
  
  if (error) throw error
  return data
}

// ç”¨æˆ·æäº¤å·¥å…·
export async function submitTool(submission: {
  tool_name: string
  tool_name_zh?: string
  tool_url: string
  tool_description: string
  tool_description_zh?: string
  tool_logo_url?: string
  category_id: string
  tags?: string[]
}) {
  const supabase = createClient()
  const { data, error } = await supabase
    .from('user_submissions')
    .insert(submission)
    .select()
    .single()
  
  if (error) throw error
  return data
}

// è·å–ç”¨æˆ·æäº¤è®°å½•
export async function getUserSubmissions() {
  const supabase = createClient()
  const { data, error } = await supabase
    .from('user_submissions')
    .select('*')
    .order('submitted_at', { ascending: false })
  
  if (error) throw error
  return data
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–
```sql
-- å¤åˆç´¢å¼•
CREATE INDEX idx_ai_tools_category_status ON ai_tools(category_id, status);
CREATE INDEX idx_user_submissions_user_status ON user_submissions(user_id, status);
```

### 2. æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä½¿ç”¨è¦†ç›–ç´¢å¼•
CREATE INDEX idx_ai_tools_list ON ai_tools(id, name, name_zh, slug, category_id, is_hot, is_new, created_at) 
WHERE status = 'active';
```

## ğŸ¯ å…³é”®ç‰¹æ€§

### RLS å®‰å…¨ç‰¹æ€§
- **æ•°æ®éš”ç¦»**: ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
- **è§’è‰²æ§åˆ¶**: ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®
- **æƒé™ç»†åŒ–**: ä¸åŒæ“ä½œæœ‰ä¸åŒçš„æƒé™è¦æ±‚

### ä¸šåŠ¡åŠŸèƒ½
- **åˆ†ç±»ç®¡ç†**: ç®€åŒ–çš„åˆ†ç±»ç»“æ„ï¼Œä»…åŒ…å«å¿…è¦å­—æ®µ
- **å·¥å…·ç®¡ç†**: å®Œæ•´çš„å·¥å…·ä¿¡æ¯ï¼Œæ”¯æŒSEOä¼˜åŒ–
- **å®¡æ ¸æµç¨‹**: å®Œæ•´çš„æäº¤å®¡æ ¸å·¥ä½œæµ

### æ€§èƒ½ç‰¹æ€§
- **ç´¢å¼•ä¼˜åŒ–**: ä¸ºå¸¸ç”¨æŸ¥è¯¢åˆ›å»ºåˆé€‚ç´¢å¼•
- **å…¨æ–‡æœç´¢**: æ”¯æŒä¸­è‹±æ–‡æœç´¢
- **åˆ†é¡µæ”¯æŒ**: æ”¯æŒå¤§é‡æ•°æ®çš„åˆ†é¡µæŸ¥è¯¢

è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆå®Œå…¨æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œä½¿ç”¨ RLS ç¡®ä¿æ•°æ®å®‰å…¨ï¼ŒåŒæ—¶ä¿æŒç®€æ´é«˜æ•ˆçš„è¡¨ç»“æ„ã€‚